<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConstExpr.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RedRadishes Core</a> &gt; <a href="index.source.html" class="el_package">redradishes.encoder</a> &gt; <span class="el_source">ConstExpr.java</span></div><h1>ConstExpr.java</h1><pre class="source lang-java linenums">package redradishes.encoder;

import com.google.common.base.Utf8;
import redradishes.UncheckedCharacterCodingException;

import java.io.ByteArrayOutputStream;
import java.nio.ByteBuffer;
import java.nio.CharBuffer;
import java.nio.charset.CharacterCodingException;
import java.nio.charset.Charset;
import java.nio.charset.CharsetEncoder;

import static java.nio.charset.StandardCharsets.UTF_8;
import static redradishes.encoder.RespEncoders.getCharsetEncoder;

public interface ConstExpr {
<span class="fc" id="L17">  ConstExpr EMPTY = new ConstExpr() {</span>
    @Override
    public int length() {
<span class="fc" id="L20">      return 0;</span>
    }

    @Override
<span class="fc" id="L24">    public void writeTo(ByteSink byteSink) { }</span>

    @Override
    public int size() {
<span class="fc" id="L28">      return 0;</span>
    }
  };

<span class="fc" id="L32">  ConstExpr NEW_ARG = new ConstExpr() {</span>
    @Override
    public int length() {
<span class="fc" id="L35">      return 1;</span>
    }

    @Override
    public void writeTo(ByteSink byteSink) {
<span class="fc" id="L40">      byteSink.write((byte) '$');</span>
<span class="fc" id="L41">    }</span>

    @Override
    public int size() {
<span class="fc" id="L45">      return 1;</span>
    }
  };

  int length();

  void writeTo(ByteSink byteSink);

  int size();

  default ConstExpr compact() {
<span class="fc" id="L56">    return this;</span>
  }

  default &lt;E extends EncoderBase&lt;E&gt;&gt; E append(E enc) {
<span class="fc" id="L60">    return enc.prepend(this);</span>
  }

  default ConstExpr append(ConstExpr c) {
<span class="fc" id="L64">    return combine(this, c);</span>
  }

  static ConstExpr byteConst(byte b) {
<span class="fc" id="L68">    return new ConstExpr() {</span>
      @Override
      public int length() {
<span class="fc" id="L71">        return 1;</span>
      }

      @Override
      public void writeTo(ByteSink byteSink) {
<span class="fc" id="L76">        byteSink.write(b);</span>
<span class="fc" id="L77">      }</span>

      @Override
      public int size() {
<span class="fc" id="L81">        return 0;</span>
      }
    };
  }

  static ConstExpr bytesConst(byte[] src) {
<span class="fc" id="L87">    return bytesConstWithSize(src, 0);</span>
  }

  static ConstExpr bytesConstWithSize(byte[] src, int size) {
<span class="fc" id="L91">    return new ConstExpr() {</span>
      @Override
      public int length() {
<span class="fc" id="L94">        return src.length;</span>
      }

      @Override
      public void writeTo(ByteSink byteSink) {
<span class="fc" id="L99">        byteSink.write(src);</span>
<span class="fc" id="L100">      }</span>

      @Override
      public int size() {
<span class="fc" id="L104">        return size;</span>
      }
    };
  }

  static ConstExpr bytesConst(byte[] src, int offset, int length) {
<span class="fc" id="L110">    return new ConstExpr() {</span>
      @Override
      public int length() {
<span class="fc" id="L113">        return length;</span>
      }

      @Override
      public void writeTo(ByteSink byteSink) {
<span class="fc" id="L118">        byteSink.write(src, offset, length);</span>
<span class="fc" id="L119">      }</span>

      @Override
      public int size() {
<span class="fc" id="L123">        return 0;</span>
      }
    };
  }

  static ConstExpr strConst(CharSequence s, Charset charset) {
<span class="fc" id="L129">    return new ConstExpr() {</span>
      @Override
      public int length() {
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if (s.length() == 0) {</span>
<span class="nc" id="L133">          return 0;</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        } else if (UTF_8.equals(charset)) {</span>
<span class="fc" id="L135">          return Utf8.encodedLength(s);</span>
        } else {
<span class="fc" id="L137">          CharsetEncoder charsetEncoder = getCharsetEncoder(charset);</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">          if (charsetEncoder.maxBytesPerChar() == 1.0) {</span>
<span class="fc" id="L139">            return s.length();</span>
          } else {
<span class="nc" id="L141">            CharBuffer charBuffer = CharBuffer.wrap(s);</span>
            try {
<span class="nc" id="L143">              return charsetEncoder.encode(charBuffer).remaining();</span>
<span class="nc" id="L144">            } catch (CharacterCodingException e) {</span>
<span class="nc" id="L145">              throw new UncheckedCharacterCodingException(e);</span>
            }
          }
        }
      }

      @Override
      public void writeTo(ByteSink byteSink) {
<span class="fc" id="L153">        byteSink.write(s, getCharsetEncoder(charset));</span>
<span class="fc" id="L154">      }</span>

      @Override
      public int size() {
<span class="fc" id="L158">        return 0;</span>
      }

      @Override
      public ConstExpr compact() {
        try {
<span class="nc" id="L164">          ByteBuffer byteBuffer = getCharsetEncoder(charset).encode(CharBuffer.wrap(s));</span>
<span class="nc" id="L165">          return bytesConst(byteBuffer.array(), 0, byteBuffer.remaining());</span>
<span class="nc" id="L166">        } catch (CharacterCodingException e) {</span>
<span class="nc" id="L167">          throw new UncheckedCharacterCodingException(e);</span>
        }
      }
    };
  }

  static ConstExpr combine(ConstExpr c1, ConstExpr c2) {
<span class="fc" id="L174">    return new ConstExpr() {</span>
      @Override
      public int length() {
<span class="fc" id="L177">        return c1.length() + c2.length();</span>
      }

      @Override
      public void writeTo(ByteSink byteSink) {
<span class="fc" id="L182">        c1.writeTo(byteSink);</span>
<span class="fc" id="L183">        c2.writeTo(byteSink);</span>
<span class="fc" id="L184">      }</span>

      @Override
      public int size() {
<span class="fc" id="L188">        return c1.size() + c2.size();</span>
      }

      @Override
      public ConstExpr compact() {
<span class="fc" id="L193">        ByteArrayOutputStream out = new ByteArrayOutputStream(length());</span>
<span class="fc" id="L194">        ByteSink sink = new ByteSink() {</span>
          @Override
          public void write(byte b) {
<span class="fc" id="L197">            out.write(b);</span>
<span class="fc" id="L198">          }</span>

          @Override
          public void write(CharSequence s, CharsetEncoder charsetEncoder) {
            try {
<span class="fc" id="L203">              ByteBuffer byteBuffer = charsetEncoder.encode(CharBuffer.wrap(s));</span>
<span class="fc" id="L204">              out.write(byteBuffer.array(), 0, byteBuffer.remaining());</span>
<span class="nc" id="L205">            } catch (CharacterCodingException e) {</span>
<span class="nc" id="L206">              throw new UncheckedCharacterCodingException(e);</span>
<span class="fc" id="L207">            }</span>
<span class="fc" id="L208">          }</span>

          @Override
          public void write(byte[] src) {
<span class="fc" id="L212">            out.write(src, 0, src.length);</span>
<span class="fc" id="L213">          }</span>

          @Override
          public void write(byte[] src, int offset, int length) {
<span class="fc" id="L217">            out.write(src, offset, length);</span>
<span class="fc" id="L218">          }</span>
        };
<span class="fc" id="L220">        c1.writeTo(sink);</span>
<span class="fc" id="L221">        c2.writeTo(sink);</span>
<span class="fc" id="L222">        byte[] bytes = out.toByteArray();</span>
<span class="fc" id="L223">        return bytesConstWithSize(bytes, size());</span>
      }
    };
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>